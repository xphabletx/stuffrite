// lib/screens/settings_screen.dart
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:package_info_plus/package_info_plus.dart';
import 'package:provider/provider.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:image_picker/image_picker.dart';
import 'package:firebase_storage/firebase_storage.dart';

import '../models/user_profile.dart';
import '../services/auth_service.dart';
import '../services/envelope_repo.dart';
import '../services/user_service.dart';
import '../services/account_security_service.dart';
import '../services/tutorial_controller.dart';
import '../services/data_export_service.dart';
import '../services/group_repo.dart';
import '../services/account_repo.dart';
import '../services/data_cleanup_service.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

import '../screens/appearance_settings_screen.dart';
import '../screens/workspace_management_screen.dart';
import '../screens/workspace_gate.dart';
import '../screens/pay_day_settings_screen.dart';
import '../services/scheduled_payment_repo.dart';
import '../services/pay_day_settings_service.dart';
import '../providers/workspace_provider.dart';
import 'package:shared_preferences/shared_preferences.dart';

class SettingsScreen extends StatelessWidget {
  const SettingsScreen({super.key, required this.repo});

  final EnvelopeRepo repo;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final userService = UserService(repo.db, repo.currentUserId);
    final currentUser = FirebaseAuth.instance.currentUser;

    return Scaffold(
      backgroundColor: theme.scaffoldBackgroundColor,
      appBar: AppBar(
        title: FittedBox(
          child: Text(
            'Settings',
            style: theme.textTheme.headlineSmall?.copyWith(
              fontWeight: FontWeight.bold,
              color: theme.colorScheme.onSurface,
            ),
          ),
        ),
        backgroundColor: theme.scaffoldBackgroundColor,
        elevation: 0,
        iconTheme: IconThemeData(color: theme.colorScheme.onSurface),
      ),
      body: StreamBuilder<UserProfile?>(
        stream: userService.userProfileStream,
        builder: (context, snapshot) {
          final profile = snapshot.data;
          final displayName = profile?.displayName ?? 'User';
          final email = currentUser?.email ?? 'No email found';

          return ListView(
            padding: const EdgeInsets.all(16),
            children: [
              // Profile Section
              _SettingsSection(
                title: 'Profile',
                icon: Icons.person_outline,
                children: [
                  _SettingsTile(
                    title: 'Profile Photo',
                    subtitle: profile?.photoURL != null
                        ? 'Tap to change'
                        : 'Tap to add',
                    leading: profile?.photoURL != null
                        ? CircleAvatar(
                            backgroundImage: NetworkImage(profile!.photoURL!),
                            radius: 20,
                          )
                        : const Icon(Icons.add_a_photo_outlined),
                    onTap: () async {
                      await _showProfilePhotoOptions(
                        context,
                        userService,
                        profile?.photoURL,
                      );
                    },
                  ),
                  _SettingsTile(
                    title: 'Display Name',
                    subtitle: displayName,
                    leading: const Icon(Icons.badge_outlined),
                    onTap: () async {
                      if (!context.mounted) return;
                      final newName = await showDialog<String>(
                        context: context,
                        builder: (ctx) {
                          final controller = TextEditingController(
                            text: displayName,
                          );
                          return AlertDialog(
                            backgroundColor: theme.colorScheme.surface,
                            title: const Text('Edit Display Name'),
                            content: TextField(
                              controller: controller,
                              decoration: const InputDecoration(
                                labelText: 'Display Name',
                                border: OutlineInputBorder(),
                              ),
                            ),
                            actions: [
                              TextButton(
                                onPressed: () => Navigator.pop(ctx),
                                child: const Text('Cancel'),
                              ),
                              TextButton(
                                onPressed: () =>
                                    Navigator.pop(ctx, controller.text),
                                child: const Text('Save'),
                              ),
                            ],
                          );
                        },
                      );
                      if (newName != null) {
                        await userService.updateUserProfile(
                          displayName: newName.trim(),
                        );
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text('Display name updated'),
                            ),
                          );
                        }
                      }
                    },
                  ),
                  _SettingsTile(
                    title: 'Email',
                    subtitle: email,
                    leading: const Icon(Icons.email_outlined),
                    onTap: null,
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // Appearance Section
              _SettingsSection(
                title: 'Appearance',
                icon: Icons.palette_outlined,
                children: [
                  _SettingsTile(
                    title: 'Customize Appearance',
                    subtitle: 'Theme, font, and celebration emoji',
                    leading: const Icon(Icons.color_lens_outlined),
                    onTap: () {
                      Navigator.of(context).push(
                        MaterialPageRoute(
                          builder: (_) => const AppearanceSettingsScreen(),
                        ),
                      );
                    },
                    trailing: const Icon(Icons.chevron_right),
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // Pay Day Settings Section
              _SettingsSection(
                title: 'Pay Day',
                icon: Icons.payments_outlined,
                children: [
                  _SettingsTile(
                    title: 'Pay Day Settings',
                    subtitle: 'Configure your pay schedule & calendar',
                    leading: const Icon(Icons.calendar_month_outlined),
                    onTap: () {
                      final payDayService = PayDaySettingsService(
                        repo.db,
                        repo.currentUserId,
                      );
                      Navigator.of(context).push(
                        MaterialPageRoute(
                          builder: (_) => PayDaySettingsScreen(
                            service: payDayService,
                          ),
                        ),
                      );
                    },
                    trailing: const Icon(Icons.chevron_right),
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // Workspace Section
              _SettingsSection(
                title: 'Workspace',
                icon: Icons.groups_outlined,
                children: [
                  if (repo.workspaceId != null) ...[
                    _SettingsTile(
                      title: 'Manage Workspace',
                      subtitle: 'Members, join code & settings',
                      leading: const Icon(Icons.settings_outlined),
                      onTap: () {
                        final wsId = repo.workspaceId;
                        if (wsId == null) return;
                        Navigator.of(context).push(
                          MaterialPageRoute(
                            builder: (_) => WorkspaceManagementScreen(
                              repo: repo,
                              workspaceId: wsId,
                              currentUserId: repo.currentUserId,
                              onWorkspaceLeft: () {
                                // The app needs to restart to pick up the workspace change
                                // For now just pop back
                                Navigator.of(context).pop();
                              },
                            ),
                          ),
                        );
                      },
                      trailing: const Icon(Icons.chevron_right),
                    ),
                  ] else ...[
                    _SettingsTile(
                      title: 'Create / Join Workspace',
                      subtitle: 'Currently in Solo Mode',
                      leading: const Icon(Icons.group_add),
                      onTap: () async {
                        await Navigator.of(context).push(
                          MaterialPageRoute(
                            builder: (_) => WorkspaceGate(
                              repo: repo,
                              onJoined: (workspaceId) {
                                ScaffoldMessenger.of(context).showSnackBar(
                                  const SnackBar(
                                    content: Text('Joined workspace!'),
                                  ),
                                );
                              },
                            ),
                          ),
                        );
                      },
                      trailing: const Icon(Icons.chevron_right),
                    ),
                  ],
                ],
              ),
              const SizedBox(height: 24),

              // Data & Privacy (Export)
              _SettingsSection(
                title: 'Data & Privacy',
                icon: Icons.lock_outline,
                children: [
                  _SettingsTile(
                    title: 'Export My Data',
                    subtitle: 'Download your data as .xlsx',
                    leading: const Icon(Icons.file_download_outlined),
                    onTap: () => _exportDataNew(context),
                  ),
                  _SettingsTile(
                    title: 'Clean Up Orphaned Data',
                    subtitle: 'Remove deleted items still in database',
                    leading: const Icon(Icons.cleaning_services_outlined),
                    onTap: () => _cleanupOrphanedData(context),
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // Legal Section
              _SettingsSection(
                title: 'Legal',
                icon: Icons.gavel_outlined,
                children: [
                  _SettingsTile(
                    title: 'Privacy Policy',
                    leading: const Icon(Icons.policy_outlined),
                    trailing: const Icon(Icons.open_in_new, size: 20),
                    onTap: () => _openUrl(
                      'https://xphabletx.github.io/envelope-lite/PRIVACY_POLICY',
                    ),
                  ),
                  _SettingsTile(
                    title: 'Terms of Service',
                    leading: const Icon(Icons.description_outlined),
                    trailing: const Icon(Icons.open_in_new, size: 20),
                    onTap: () => _openUrl(
                      'https://xphabletx.github.io/envelope-lite/TERMS_OF_SERVICE',
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // Support Section
              _SettingsSection(
                title: 'Support',
                icon: Icons.support_agent_outlined,
                children: [
                  _SettingsTile(
                    title: 'Contact Us',
                    leading: const Icon(Icons.email_outlined),
                    onTap: () async {
                      final Uri emailLaunchUri = Uri(
                        scheme: 'mailto',
                        path: 'telmccall@gmail.com',
                        query: 'subject=Envelope Lite Support',
                      );
                      if (!await launchUrl(emailLaunchUri)) {
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text('Could not launch email client'),
                            ),
                          );
                        }
                      }
                    },
                    trailing: const Icon(Icons.chevron_right),
                  ),
                  // TUTORIAL RESET BUTTON - UPDATED
                  _SettingsTile(
                    title: 'Replay Tutorial',
                    subtitle: 'Show the onboarding tour again',
                    leading: const Icon(Icons.help_outline),
                    onTap: () async {
                      // Using the new controller reset logic
                      context.read<TutorialController>().reset();

                      if (context.mounted) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                            content: Text(
                              'Tutorial reset! Return to home to start again',
                            ),
                          ),
                        );
                        // Navigate back to home
                        Navigator.of(
                          context,
                        ).popUntil((route) => route.isFirst);
                      }
                    },
                  ),
                  FutureBuilder<PackageInfo>(
                    future: PackageInfo.fromPlatform(),
                    builder: (context, snapshot) {
                      String versionText = 'Loading...';
                      if (snapshot.hasData) {
                        versionText =
                            '${snapshot.data!.version} (${snapshot.data!.buildNumber})';
                      }

                      return _SettingsTile(
                        title: 'App Version',
                        subtitle: versionText,
                        leading: const Icon(Icons.info_outlined),
                        onTap: null,
                      );
                    },
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // Logout
              _SettingsSection(
                title: 'Account',
                icon: Icons.account_circle_outlined,
                children: [
                  _SettingsTile(
                    title: 'Logout',
                    leading: Icon(Icons.logout, color: theme.colorScheme.error),
                    titleColor: theme.colorScheme.error,
                    onTap: () async {
                      final confirm = await showDialog<bool>(
                        context: context,
                        builder: (ctx) => AlertDialog(
                          title: const Text('Logout?'),
                          content: const Text(
                            'Are you sure you want to logout?',
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(ctx, false),
                              child: const Text('Cancel'),
                            ),
                            TextButton(
                              onPressed: () => Navigator.pop(ctx, true),
                              style: TextButton.styleFrom(
                                foregroundColor: theme.colorScheme.error,
                              ),
                              child: const Text('Logout'),
                            ),
                          ],
                        ),
                      );

                      if (confirm == true && context.mounted) {
                        // Show loading indicator
                        showDialog(
                          context: context,
                          barrierDismissible: false,
                          builder: (ctx) => const Center(
                            child: CircularProgressIndicator(),
                          ),
                        );

                        try {
                          await AuthService.signOut();
                          // Dismiss loading dialog after sign out completes
                          if (context.mounted) {
                            Navigator.pop(context); // Dismiss loading
                          }
                          // Navigation to SignInScreen will be handled by auth state listener
                        } catch (e) {
                          if (context.mounted) {
                            Navigator.pop(context); // Dismiss loading
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(
                                content: Text('Logout failed: $e'),
                                backgroundColor: Colors.red,
                              ),
                            );
                          }
                        }
                      }
                    },
                  ),
                ],
              ),
              const SizedBox(height: 32),

              // Developer Tools (Debug Mode Only)
              if (kDebugMode) ...[
                _SettingsSection(
                  title: 'Developer Tools',
                  icon: Icons.developer_mode,
                  children: [
                    _SettingsTile(
                      title: 'Reset Migration Status',
                      subtitle: 'Reset to Firebase mode (testing only)',
                      leading: const Icon(Icons.restore, color: Colors.orange),
                      titleColor: Colors.orange,
                      onTap: () async {
                        final confirm = await showDialog<bool>(
                          context: context,
                          builder: (ctx) => AlertDialog(
                            title: const Text('Reset Migration?'),
                            content: const Text(
                              'This will reset your migration status back to Firebase mode. '
                              'Only use this for testing!\n\n'
                              'You will need to restart the app after resetting.',
                            ),
                            actions: [
                              TextButton(
                                onPressed: () => Navigator.pop(ctx, false),
                                child: const Text('Cancel'),
                              ),
                              FilledButton(
                                onPressed: () => Navigator.pop(ctx, true),
                                style: FilledButton.styleFrom(
                                  backgroundColor: Colors.orange,
                                ),
                                child: const Text('Reset'),
                              ),
                            ],
                          ),
                        );

                        if (confirm == true && context.mounted) {
                          try {
                            await MigrationStatusService().resetMigrationStatus();

                            if (context.mounted) {
                              ScaffoldMessenger.of(context).showSnackBar(
                                const SnackBar(
                                  content: Text(
                                    'Migration status reset. Please restart the app to use Firebase mode.',
                                  ),
                                  duration: Duration(seconds: 5),
                                  backgroundColor: Colors.orange,
                                ),
                              );
                            }
                          } catch (e) {
                            if (context.mounted) {
                              ScaffoldMessenger.of(context).showSnackBar(
                                SnackBar(
                                  content: Text('Reset failed: $e'),
                                  backgroundColor: Colors.red,
                                ),
                              );
                            }
                          }
                        }
                      },
                    ),
                  ],
                ),
                const SizedBox(height: 24),
              ],

              // DANGER ZONE
              const Divider(),
              const SizedBox(height: 16),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16.0),
                child: Text(
                  'Danger Zone',
                  style: theme.textTheme.titleSmall?.copyWith(
                    fontWeight: FontWeight.bold,
                    color: theme.colorScheme.error,
                  ),
                ),
              ),
              const SizedBox(height: 8),
              ListTile(
                leading: Icon(
                  Icons.delete_forever,
                  color: theme.colorScheme.error,
                ),
                title: Text(
                  'Delete Account',
                  style: theme.textTheme.bodyLarge?.copyWith(
                    fontWeight: FontWeight.bold,
                    color: theme.colorScheme.error,
                  ),
                ),
                subtitle: const Text('Permanently delete account and all data'),
                onTap: () async {
                  // NEW: Use the service instead of manual code
                  final securityService = AccountSecurityService();
                  await securityService.deleteAccount(context);
                },
              ),
              const SizedBox(height: 32),
            ],
          );
        },
      ),
    );
  }

  // --- Helpers ---

  Future<void> _showProfilePhotoOptions(
    BuildContext context,
    UserService userService,
    String? currentPhotoURL,
  ) async {
    final theme = Theme.of(context);

    await showModalBottomSheet(
      context: context,
      backgroundColor: theme.colorScheme.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (ctx) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const SizedBox(height: 16),
            Container(
              width: 40,
              height: 4,
              decoration: BoxDecoration(
                color: theme.colorScheme.onSurfaceVariant.withAlpha(128),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            const SizedBox(height: 24),
            if (currentPhotoURL != null)
              ListTile(
                leading: const Icon(Icons.visibility_outlined),
                title: const Text('View Photo'),
                onTap: () {
                  Navigator.pop(ctx);
                  _showFullPhoto(context, currentPhotoURL);
                },
              ),
            ListTile(
              leading: const Icon(Icons.photo_library_outlined),
              title: const Text('Choose from Gallery'),
              onTap: () async {
                Navigator.pop(ctx);
                await _pickAndUploadPhoto(context, userService);
              },
            ),
            if (currentPhotoURL != null)
              ListTile(
                leading: Icon(Icons.delete_outline, color: theme.colorScheme.error),
                title: Text(
                  'Remove Photo',
                  style: TextStyle(color: theme.colorScheme.error),
                ),
                onTap: () async {
                  Navigator.pop(ctx);
                  await _removePhoto(context, userService);
                },
              ),
            ListTile(
              leading: const Icon(Icons.close),
              title: const Text('Cancel'),
              onTap: () => Navigator.pop(ctx),
            ),
            const SizedBox(height: 16),
          ],
        ),
      ),
    );
  }

  Future<void> _showFullPhoto(BuildContext context, String photoURL) async {
    await showDialog(
      context: context,
      builder: (ctx) => Dialog(
        backgroundColor: Colors.transparent,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            ClipRRect(
              borderRadius: BorderRadius.circular(16),
              child: Image.network(
                photoURL,
                fit: BoxFit.contain,
                loadingBuilder: (context, child, loadingProgress) {
                  if (loadingProgress == null) return child;
                  return const SizedBox(
                    height: 200,
                    child: Center(child: CircularProgressIndicator()),
                  );
                },
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    height: 200,
                    color: Colors.grey,
                    child: const Icon(Icons.error, color: Colors.white),
                  );
                },
              ),
            ),
            const SizedBox(height: 16),
            TextButton(
              onPressed: () => Navigator.pop(ctx),
              style: TextButton.styleFrom(
                backgroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 12),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(20),
                ),
              ),
              child: const Text('Close'),
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _pickAndUploadPhoto(
    BuildContext context,
    UserService userService,
  ) async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(
      source: ImageSource.gallery,
      maxWidth: 800,
      maxHeight: 800,
      imageQuality: 85,
    );

    if (pickedFile == null) return;

    if (!context.mounted) return;

    // Show loading dialog
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) => const Center(child: CircularProgressIndicator()),
    );

    try {
      final imageFile = File(pickedFile.path);
      final userId = userService.userId;
      final storageRef = FirebaseStorage.instance
          .ref()
          .child('user_photos')
          .child('$userId.jpg');

      await storageRef.putFile(imageFile);
      final downloadUrl = await storageRef.getDownloadURL();

      await userService.updateUserProfile(photoURL: downloadUrl);

      if (context.mounted) {
        Navigator.pop(context); // Dismiss loading dialog
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Profile photo updated')),
        );
      }
    } catch (e) {
      if (context.mounted) {
        Navigator.pop(context); // Dismiss loading dialog
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error uploading photo: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future<void> _removePhoto(
    BuildContext context,
    UserService userService,
  ) async {
    final confirm = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Remove Photo?'),
        content: const Text('Are you sure you want to remove your profile photo?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(ctx, true),
            style: TextButton.styleFrom(
              foregroundColor: Theme.of(context).colorScheme.error,
            ),
            child: const Text('Remove'),
          ),
        ],
      ),
    );

    if (confirm != true || !context.mounted) return;

    try {
      await userService.updateUserProfile(photoURL: '');

      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Profile photo removed')),
        );
      }
    } catch (e) {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error removing photo: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future<void> _openUrl(String url) async {
    final uri = Uri.parse(url);
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      debugPrint('Could not launch $url');
    }
  }

  Future<void> _forceSoloMode(BuildContext context) async {
    final theme = Theme.of(context);

    // Confirm with user
    final confirm = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: theme.colorScheme.surface,
        title: const Text('Force Solo Mode?'),
        content: const Text(
          'This will:\n'
          '‚Ä¢ Clear any workspace association\n'
          '‚Ä¢ Use ONLY local Hive storage\n'
          '‚Ä¢ Stop syncing to Firebase\n'
          '‚Ä¢ Clear Firebase cache\n\n'
          'Your local data will be preserved.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: const Text('Cancel'),
          ),
          FilledButton(
            onPressed: () => Navigator.pop(ctx, true),
            child: const Text('Enable Solo Mode'),
          ),
        ],
      ),
    );

    if (confirm != true) return;

    try {
      debugPrint('[Settings] üîß Forcing solo mode...');

      // 1. Clear SharedPreferences FIRST
      final prefs = await SharedPreferences.getInstance();

      final removed1 = await prefs.remove('active_workspace_id');
      final removed2 = await prefs.remove('last_workspace_id');
      final removed3 = await prefs.remove('last_workspace_name');

      debugPrint('[Settings] Cleared active_workspace_id: $removed1');
      debugPrint('[Settings] Cleared last_workspace_id: $removed2');
      debugPrint('[Settings] Cleared last_workspace_name: $removed3');

      // VERIFY they're actually gone
      final verify1 = prefs.getString('active_workspace_id');
      final verify2 = prefs.getString('last_workspace_id');
      final verify3 = prefs.getString('last_workspace_name');

      debugPrint('[Settings] VERIFY - active_workspace_id: ${verify1 ?? "NULL ‚úÖ"}');
      debugPrint('[Settings] VERIFY - last_workspace_id: ${verify2 ?? "NULL ‚úÖ"}');
      debugPrint('[Settings] VERIFY - last_workspace_name: ${verify3 ?? "NULL ‚úÖ"}');

      if (verify1 != null || verify2 != null || verify3 != null) {
        throw Exception('Failed to clear workspace IDs from SharedPreferences!');
      }

      // 2. Clear workspace from Firebase user document
      final userId = FirebaseAuth.instance.currentUser?.uid;
      if (userId != null) {
        await FirebaseFirestore.instance.collection('users').doc(userId).set({
          'activeWorkspaceId': null,
        }, SetOptions(merge: true));
        debugPrint('[Settings] ‚úÖ Cleared activeWorkspaceId from Firebase user document');
      }

      // 3. Update WorkspaceProvider if it exists
      if (context.mounted) {
        try {
          final workspaceProvider = Provider.of<WorkspaceProvider>(context, listen: false);
          await workspaceProvider.setWorkspaceId(null);
          debugPrint('[Settings] ‚úÖ WorkspaceProvider cleared');
        } catch (e) {
          debugPrint('[Settings] ‚ö†Ô∏è WorkspaceProvider not found (may not exist): $e');
        }
      }

      // 4. Update the EnvelopeRepo to force it to re-check workspace status
      // The repo will see workspaceId is now null when it checks
      await repo.setWorkspace(null);
      debugPrint('[Settings] ‚úÖ EnvelopeRepo workspace cleared');

      // 5. NEW: Clear Firebase cache to remove ghost listeners
      try {
        debugPrint('[Settings] üî• Terminating Firebase connections...');
        await FirebaseFirestore.instance.terminate();

        debugPrint('[Settings] üî• Clearing Firebase persistence...');
        await FirebaseFirestore.instance.clearPersistence();

        debugPrint('[Settings] ‚úÖ Firebase cache cleared');
      } catch (e) {
        debugPrint('[Settings] ‚ö†Ô∏è Error clearing Firebase cache: $e');
        // Continue anyway - not critical
      }

      if (!context.mounted) return;

      // Show success
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('‚úì Solo mode enabled. App will reload...'),
          duration: Duration(seconds: 2),
        ),
      );

      // Wait for snackbar
      await Future.delayed(const Duration(seconds: 2));

      // Restart app by popping to root
      if (context.mounted) {
        Navigator.of(context).popUntil((route) => route.isFirst);
      }
    } catch (e) {
      debugPrint('[Settings] ‚ùå Error forcing solo mode: $e');
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error: $e')),
        );
      }
    }
  }

  Future<void> _clearFirebaseCache(BuildContext context) async {
    // Show confirmation dialog
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Clear Firebase Cache?'),
        content: const Text(
          'This will:\n'
          '‚Ä¢ Remove all offline Firebase data\n'
          '‚Ä¢ Close all Firebase connections\n'
          '‚Ä¢ Fix ghost listener issues\n\n'
          'Your local Hive data is safe.\n\n'
          'The app will restart after clearing.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancel'),
          ),
          FilledButton(
            onPressed: () => Navigator.pop(context, true),
            style: FilledButton.styleFrom(
              backgroundColor: Colors.orange,
            ),
            child: const Text('Clear Cache'),
          ),
        ],
      ),
    );

    if (confirmed != true) return;

    if (!context.mounted) return;

    try {
      debugPrint('[Settings] üî• Clearing Firebase cache...');

      // Show loading
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => const Center(
          child: Card(
            child: Padding(
              padding: EdgeInsets.all(24),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  CircularProgressIndicator(),
                  SizedBox(height: 16),
                  Text('Clearing Firebase cache...'),
                ],
              ),
            ),
          ),
        ),
      );

      // Terminate Firebase
      await FirebaseFirestore.instance.terminate();
      debugPrint('[Settings] ‚úÖ Firebase connections terminated');

      // Clear persistence
      await FirebaseFirestore.instance.clearPersistence();
      debugPrint('[Settings] ‚úÖ Firebase persistence cleared');

      // Close loading dialog
      if (context.mounted) {
        Navigator.pop(context);
      }

      // Show success
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('‚úì Firebase cache cleared. Restarting app...'),
            duration: Duration(seconds: 2),
          ),
        );
      }

      // Wait for snackbar
      await Future.delayed(const Duration(seconds: 2));

      // Restart app
      if (context.mounted) {
        Navigator.of(context).popUntil((route) => route.isFirst);
      }

    } catch (e) {
      debugPrint('[Settings] ‚ùå Error clearing Firebase cache: $e');

      // Close loading if still showing
      if (context.mounted) {
        Navigator.of(context).popUntil((route) => route.isFirst);
      }

      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future<void> _syncToFirebase(BuildContext context) async {
    final theme = Theme.of(context);

    // Confirm with user
    final confirm = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: theme.colorScheme.surface,
        title: const Text('Sync to Firebase?'),
        content: const Text(
          'This will upload all your local data to Firebase cloud storage.\n\n'
          'Use this to:\n'
          '‚Ä¢ Create a cloud backup of your local data\n'
          '‚Ä¢ Prepare for workspace mode\n'
          '‚Ä¢ Restore data to Firebase\n\n'
          'This may take a few moments for large datasets.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: const Text('Cancel'),
          ),
          FilledButton(
            onPressed: () => Navigator.pop(ctx, true),
            child: const Text('Sync Now'),
          ),
        ],
      ),
    );

    if (confirm != true || !context.mounted) return;

    // Show progress dialog
    String currentProgress = 'Initializing...';
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) => AlertDialog(
        backgroundColor: theme.colorScheme.surface,
        content: StatefulBuilder(
          builder: (context, setState) {
            return Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const CircularProgressIndicator(),
                const SizedBox(height: 16),
                Text(currentProgress),
              ],
            );
          },
        ),
      ),
    );

    try {
      final migrationService = HiveMigrationService(
        FirebaseFirestore.instance,
        FirebaseAuth.instance,
      );

      final result = await migrationService.syncToFirebase(
        onProgress: (progress) {
          currentProgress = progress;
          // Update dialog (if still mounted)
        },
      );

      if (!context.mounted) return;

      // Dismiss progress dialog
      Navigator.of(context).pop();

      if (result['success'] == true) {
        // Show success dialog
        showDialog(
          context: context,
          builder: (ctx) => AlertDialog(
            backgroundColor: theme.colorScheme.surface,
            title: Row(
              children: [
                Icon(Icons.check_circle, color: theme.colorScheme.primary),
                const SizedBox(width: 8),
                const Text('Sync Complete'),
              ],
            ),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('Successfully synced to Firebase:'),
                const SizedBox(height: 12),
                Text('‚Ä¢ ${result['envelopes'] ?? 0} envelopes'),
                Text('‚Ä¢ ${result['accounts'] ?? 0} accounts'),
                Text('‚Ä¢ ${result['groups'] ?? 0} groups'),
                Text('‚Ä¢ ${result['transactions'] ?? 0} transactions'),
                Text('‚Ä¢ ${result['scheduledPayments'] ?? 0} scheduled payments'),
              ],
            ),
            actions: [
              FilledButton(
                onPressed: () => Navigator.pop(ctx),
                child: const Text('Done'),
              ),
            ],
          ),
        );
      } else {
        // Show error dialog
        showDialog(
          context: context,
          builder: (ctx) => AlertDialog(
            backgroundColor: theme.colorScheme.surface,
            title: Row(
              children: [
                Icon(Icons.error, color: theme.colorScheme.error),
                const SizedBox(width: 8),
                const Text('Sync Failed'),
              ],
            ),
            content: Text(
              'Failed to sync data to Firebase:\n\n${result['error'] ?? 'Unknown error'}',
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(ctx),
                child: const Text('OK'),
              ),
            ],
          ),
        );
      }
    } catch (e) {
      if (!context.mounted) return;

      // Dismiss progress dialog if still showing
      Navigator.of(context).pop();

      // Show error
      showDialog(
        context: context,
        builder: (ctx) => AlertDialog(
          backgroundColor: theme.colorScheme.surface,
          title: Row(
            children: [
              Icon(Icons.error, color: theme.colorScheme.error),
              const SizedBox(width: 8),
              const Text('Sync Failed'),
            ],
          ),
          content: Text('Error syncing to Firebase:\n\n$e'),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(ctx),
              child: const Text('OK'),
            ),
          ],
        ),
      );
    }
  }

  Future<void> _exportDataNew(BuildContext context) async {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(child: CircularProgressIndicator()),
    );

    try {
      final groupRepo = GroupRepo(repo.db, repo);
      final scheduledPaymentRepo = ScheduledPaymentRepo(repo.db, repo.currentUserId);
      final accountRepo = AccountRepo(
        repo.db,
        repo,
      ); // New: Instantiate AccountRepo

      final dataExportService = DataExportService(
        envelopeRepo: repo,
        groupRepo: groupRepo,
        scheduledPaymentRepo: scheduledPaymentRepo,
        accountRepo: accountRepo, // New: Pass AccountRepo
      );

      final filePath = await dataExportService.generateExcelFile();

      if (context.mounted) {
        Navigator.of(context).pop(); // Dismiss the progress dialog
        await DataExportService.showExportOptions(context, filePath);
      }
    } catch (e) {
      if (context.mounted) {
        Navigator.of(context).pop();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Export failed: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future<void> _cleanupOrphanedData(BuildContext context) async {
    final theme = Theme.of(context);

    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: theme.colorScheme.surface,
        title: const Text('Clean Up Database?'),
        content: const Text(
          'This will find and delete:\n'
          '‚Ä¢ Scheduled payments for deleted envelopes/groups\n'
          '‚Ä¢ Transactions for deleted envelopes\n\n'
          'This action cannot be undone.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            style: TextButton.styleFrom(foregroundColor: Colors.orange),
            child: const Text('Clean Up'),
          ),
        ],
      ),
    );

    if (confirm != true || !context.mounted) return;

    // Show loading
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(child: CircularProgressIndicator()),
    );

    try {
      final cleanup = DataCleanupService(
        FirebaseFirestore.instance,
        FirebaseAuth.instance.currentUser!.uid,
      );

      final results = await cleanup.cleanupAll();
      final paymentsDeleted = results['payments'] ?? 0;
      final txDeleted = results['transactions'] ?? 0;

      if (context.mounted) {
        Navigator.pop(context); // Close loading

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Cleaned up $paymentsDeleted payment(s) and $txDeleted transaction(s)',
            ),
            backgroundColor: Colors.green,
            duration: const Duration(seconds: 4),
          ),
        );
      }
    } catch (e) {
      if (context.mounted) {
        Navigator.pop(context); // Close loading
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Cleanup failed: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }
}

class _SettingsSection extends StatelessWidget {
  const _SettingsSection({
    required this.title,
    required this.icon,
    required this.children,
  });

  final String title;
  final IconData icon;
  final List<Widget> children;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.only(left: 16, bottom: 8),
          child: Row(
            children: [
              Icon(icon, size: 20, color: theme.colorScheme.primary),
              const SizedBox(width: 8),
              Text(
                title,
                style: theme.textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.bold,
                  color: theme.colorScheme.primary,
                ),
              ),
            ],
          ),
        ),
        Container(
          decoration: BoxDecoration(
            color: theme.colorScheme.surface,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withAlpha(13),
                blurRadius: 4,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: Column(children: children),
        ),
      ],
    );
  }
}

class _SettingsTile extends StatelessWidget {
  const _SettingsTile({
    required this.title,
    this.subtitle,
    this.leading,
    this.trailing,
    this.onTap,
    this.titleColor,
  });

  final String title;
  final String? subtitle;
  final Widget? leading;
  final Widget? trailing;
  final VoidCallback? onTap;
  final Color? titleColor;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return ListTile(
      leading: leading != null
          ? IconTheme(
              data: IconThemeData(
                color: titleColor ?? theme.colorScheme.onSurfaceVariant,
              ),
              child: leading!,
            )
          : null,
      title: Text(
        title,
        style: theme.textTheme.bodyLarge?.copyWith(
          fontWeight: FontWeight.w500,
          color: titleColor ?? theme.colorScheme.onSurface,
        ),
      ),
      subtitle: subtitle != null
          ? Text(
              subtitle!,
              style: theme.textTheme.bodyMedium?.copyWith(
                color: theme.colorScheme.onSurfaceVariant,
              ),
            )
          : null,
      trailing: trailing != null
          ? IconTheme(
              data: IconThemeData(
                color: theme.colorScheme.onSurfaceVariant.withAlpha(128),
              ),
              child: trailing!,
            )
          : null,
      onTap: onTap,
      enabled: onTap != null,
    );
  }
}
